name: Build and Deploy to IPFS

permissions:
    contents: read
    pull-requests: write
    statuses: write

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main
    workflow_dispatch:  # Also allow manual trigger

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        outputs:
            cid: ${{ steps.deploy.outputs.cid }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Ruby
              uses: ruby/setup-ruby@v1
              with:
                  ruby-version: "3.2"
                  bundler-cache: true

            - name: Install Jekyll dependencies
              run: bundle install

            - name: Build Jekyll site
              run: bundle exec jekyll build
              env:
                  JEKYLL_ENV: production

            - name: Deploy to IPFS
              uses: ipshipyard/ipfs-deploy-action@v1
              id: deploy
              with:
                  path-to-deploy: _site
                  storacha-key: ${{ secrets.STORACHA_KEY }}
                  storacha-proof: ${{ secrets.STORACHA_PROOF }}
                  github-token: ${{ github.token }}
                  # Optional: Pin to Pinata for redundancy
                  # pinata-jwt-token: ${{ secrets.PINATA_JWT_TOKEN }}

            - name: Summary
              run: |
                  echo "## ðŸš€ IPFS Deployment Successful!" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**CID:** \`${{ steps.deploy.outputs.cid }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Access your site:" >> $GITHUB_STEP_SUMMARY
                  echo "- [IPFS Gateway (dweb.link)](https://${{ steps.deploy.outputs.cid }}.ipfs.dweb.link)" >> $GITHUB_STEP_SUMMARY
                  echo "- [IPFS Gateway (cf-ipfs)](https://${{ steps.deploy.outputs.cid }}.ipfs.cf-ipfs.com)" >> $GITHUB_STEP_SUMMARY
                  echo "- [IPFS Gateway (w3s.link)](https://${{ steps.deploy.outputs.cid }}.ipfs.w3s.link)" >> $GITHUB_STEP_SUMMARY
